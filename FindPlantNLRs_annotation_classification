import os
genome="genome/"
configfile: "FindPlantNLRs.config"
SAMPLES = list(set([x.split(".")[0] for x in os.listdir(genome) if x.endswith("fa")]))
path = 'tmp'
if not os.path.exists(path):
       os.mkdir(path)
result = 'result'
if not os.path.exists(result):
       os.mkdir(result)
rule all:
     input:
	 expand('result/{sample}_interproscan.tsv', sample=SAMPLES),
	 expand('result/{sample}_augustus_aa.fasta', sample=SAMPLES),
         expand('result/{sample}_NLRclassification.done', sample=SAMPLES)
#RefPlant_aa.fa is from https://www.biorxiv.org/content/10.1101/2020.07.08.193961v2
#Remember to correct the path for braker.pl and replace braker_2.1.6 with the version you use
#Remove sample species from config file of braker if you stopped once#
#Set alignment tools as 
rule braker:
    input:
        raw="tmp/{sample}.all_20kbflanking_merged_upper.fasta"
    output:
        removed="tmp/{sample}_all_20kbflanking_removed.fasta",
        hints_gtf="tmp/{sample}_braker.gtf",
	gff3="result/{sample}_augustus.gff3",
	aa="result/{sample}_augustus_aa.fasta"
    params:
        "{sample}"
    run:
        shell("sed 's/(//;s/)//' {input.raw} > {output.removed}")
	shell("perl {config[braker]}/braker.pl --cores=15 --genome={output.removed} --prot_seq={config[ref]} --prg=ph --epmode --species={params}")
        shell("perl {config[augustus]} < {config[braker]}/scripts/augustus.hints.gtf --printExon --out={out.gff3} --gff3")
        shell("mv {config[braker]}/scripts/braker.gtf {output.hints_gtf}")
	shell("sed -e 's/\*//g' {config[braker]}/scripts/augustus.hints.aa >  {output.aa}")
        shell("rm -r {config[braker]}/scripts/GeneMark-EP {config[braker]}/scripts/GeneMark-ES")
#Interproscan
rule Interproscan_classification:
    input:
        fasta="result/{sample}_augustus_aa.fasta",
        gff="result/{sample}_augustus.gff3"
    output:
        interpro="result/{sample}_interproscan.tsv",
        touch_file="result/{sample}_NLRclassification.done"
    shell:
        """
        bash {config[interproscan]} -t p -appl Pfam, COILS, Gene3D -i {input.fasta} -cpu 16 -f tsv -o {output.interpro}
        bash NLR_classification.awk {output.interpro} {input.gff}
        touch {output.touch_file}
	"""
